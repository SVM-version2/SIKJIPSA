<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>오후의 식물 | 식물 상담소</title>
  <meta name="description" content="초보 식집사를 위한 반려식물 진단과 이름 찾기, 추천을 사진으로 쉽게 해결!">
  <meta name="keywords" content="오후의 식물, 식물, 테라리움, 인테리어화분, 미니식물, 화분, 반려식물, 식물추천, 식물상담, 플랜테리어, 식집사">
  <meta property="og:type" content="website">
  <meta property="og:title" content="오후의 식물 | 인테리어화분 & 미니식물 추천">
  <meta property="og:description" content="초보 식집사를 위한 반려식물 진단과 이름 찾기, 추천을 사진으로 쉽게 해결!">
  <meta property="og:image" content="https://plantnoon.com/">
  <meta property="og:url" content="https://plantnoon.com/">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="오후의 식물 | 식물 추천, 테라리움, 미니식물, 화분 상담소">
  <meta name="twitter:description" content="초보 식집사를 위한 반려식물 진단과 이름 찾기, 추천을 사진으로 쉽게 해결!">
  <meta name="twitter:image" content="https://plantnoon.com/logo.png">

    <link rel="icon" href="logo.png?v=2" type="image/png">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="navigation.css">


        <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyC7mA9xLOFb98i5hKNWjKW_fORWNHvPx2s",
  authDomain: "sik-jip-sa.firebaseapp.com",
  projectId: "sik-jip-sa",
  storageBucket: "sik-jip-sa.firebasestorage.app",
  messagingSenderId: "401707534850",
  appId: "1:401707534850:web:e15b2f67e2d4484a07351b",
  measurementId: "G-HX50P6C0NT"
};
 // Firebase 앱 초기화
 if (!firebase.apps.length) {
  firebase.initializeApp(firebaseConfig);
 }
</script>

<style>
/* 변수 설정 */
:root {
    --bg-cream: #FBF8F3;
    --chat-bg: #ffffff;
    --plant-bubble-bg: #e8f5e9;
    --user-bubble-bg: #6B7B61;
    --user-bubble-text: #ffffff;
    --text-dark: #4E4A42;
    --border-light: #eaeaea;
}


main {
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    padding: 100px 20px 40px;
}

/* 챗봇 컨테이너 */
.chat-container {
    width: 100%;
    max-width: 600px;
    height: 70vh;
    max-height: 700px;
    background: var(--chat-bg);
    border-radius: 24px;
    box-shadow: 0 15px 40px rgba(0,0,0,0.1);
    display: flex;
    flex-direction: column;
}

/* 메시지 영역 */
.message-area {
    flex-grow: 1;
    padding: 24px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
}

/* 말풍선 스타일 */
.message-bubble {
    padding: 12px 18px;
    border-radius: 20px;
    margin-bottom: 12px;
    max-width: 80%;
    line-height: 1.6;
    opacity: 0;
    transform: translateY(10px);
    animation: popIn 0.4s forwards;
}

@keyframes popIn {
    to { opacity: 1; transform: translateY(0); }
}

/* 식물(봇) 말풍선 */
.plant-message {
    background: var(--plant-bubble-bg);
    color: var(--text-dark);
    border-bottom-left-radius: 4px;
    align-self: flex-start;
}

/* 사용자 말풍선 */
.user-message {
    background: var(--user-bubble-bg);
    color: var(--user-bubble-text);
    border-bottom-right-radius: 4px;
    align-self: flex-end;
}

/* 답변 버튼 영역 */
.option-area {
    padding: 16px;
    border-top: 1px solid var(--border-light);
    background: var(--chat-bg);
    border-bottom-left-radius: 24px;
    border-bottom-right-radius: 24px;
}

.option-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    justify-content: center;
    opacity: 0;
    animation: popIn 0.5s 0.3s forwards;
}

.option-buttons button {
    padding: 10px 16px;
    border: 1px solid var(--user-bubble-bg);
    color: var(--user-bubble-bg);
    background: #fff;
    border-radius: 30px;
    cursor: pointer;
    font-size: 0.9rem;
    font-weight: 500;
    transition: all 0.2s ease;
}
.option-buttons button:hover {
    background: var(--user-bubble-bg);
    color: #fff;
}

/* 타이핑 인디케이터 */
.typing-indicator {
    display: flex;
    align-items: center;
    padding: 12px 18px;
}
.typing-indicator span {
    height: 8px;
    width: 8px;
    background-color: #ccc;
    border-radius: 50%;
    display: inline-block;
    margin: 0 2px;
    animation: bounce 1.2s infinite;
}
.typing-indicator span:nth-of-type(2) { animation-delay: 0.2s; }
.typing-indicator span:nth-of-type(3) { animation-delay: 0.4s; }

@keyframes bounce {
    0%, 60%, 100% { transform: translateY(0); }
    30% { transform: translateY(-6px); }
}

/* 결과 카드 */
/* 결과 카드를 클릭 가능하게 보이도록 수정 */
.result-card-wrapper {
    background: #fff;
    border-radius: 12px;
    padding: 16px;
    margin-top: 8px;
    border: 1px solid var(--border-light);
    cursor: pointer; /* 클릭 가능함을 나타내는 커서 */
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}
.result-card-wrapper:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0,0,0,0.08);
}
.result-card-wrapper img {
    width: 100%;
    height: 150px;
    object-fit: cover;
    border-radius: 8px;
    margin-bottom: 12px;
}
.result-card-wrapper h3 { margin: 0 0 4px; font-family: 'Playfair Display', serif; }
.result-card-wrapper p { margin: 0; font-size: 0.9rem; color: #777; }



/* ⬇️ 아래 내용을 <style> 태그 안에 추가하세요 ⬇️ */

/* 동적 캐릭터 */
/* 1. 기본 상태의 plant와 character에 transition 추가 */
/* ⬇️ 캐릭터 관련 CSS 전체를 이 코드로 교체하세요 ⬇️ */

/* "펑!" 효과를 위한 애니메이션 정의 */
@keyframes puff-effect {
  0% {
    transform: scale(0);
    opacity: 0.8;
  }
  100% {
    transform: scale(1.2); /* 크기를 1.2배로 키움 */
    opacity: 0; /* 완전히 투명하게 만듦 */
  }
}

/* --- 캐릭터 기본 스타일 --- */

.plant-character {
    position: fixed;
    bottom: 40px;
    left: calc(50% - 400px);
    z-index: 10;
    transition: opacity 0.5s ease-in-out, visibility 0.5s;
    opacity: 1;
    visibility: visible;
}

.pot {
    width: 100px;
    height: 90px;
    background: #D4A373; /* 흙색 계열 */
    border-radius: 0 0 40px 40px;
    position: relative; /* ::after 요소를 제어하기 위해 추가 */
}

.pot::before { /* 화분 윗부분 장식 */
    content: '';
    position: absolute;
    top: 0;
    left: -10px;
    width: 120px;
    height: 20px;
    background: #bb8a5a;
    border-radius: 10px;
}

/* "펑" 효과를 담당할 가상 요소 */
.pot::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border-radius: 50%;
    box-shadow: inset 0 0 30px #ffffff;
    transform: scale(0);
    opacity: 0;
}

.eyes {
    position: absolute;
    bottom: 35px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 15px;
}

.eye {
    width: 10px;
    height: 10px;
    background: #4E4A42;
    border-radius: 50%;
    transition: all 0.3s ease;
}

.plant {
    position: absolute;
    bottom: 70px;
    left: 50%;
    transform-origin: bottom center;
    transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55); /* 통통 튀는 듯한 전환 효과 */
}

.leaf {
    width: 20px;
    height: 50px;
    background: #81a373; /* 식물 잎 색 */
    border-radius: 50% 50% 0 50%;
    position: absolute;
    bottom: 0;
    transform-origin: bottom center;
}

.leaf-1 {
    transform: rotate(-15deg) translateX(-10px);
}
.leaf-2 {
    transform: rotate(5deg);
    height: 60px;
}
.leaf-3 {
    transform: rotate(20deg) translateX(10px);
}


/* --- 캐릭터 숨겨질 때 애니메이션 --- */

.plant-character.hidden {
    opacity: 0;
    visibility: hidden;
    transition-delay: 0.2s; /* 잎이 다 들어간 후 0.2초 뒤에 투명해지도록 설정 */
}

.plant-character.hidden .plant {
    /* Y축으로 60px만큼 내려가 화분 속에 숨은 것처럼 보이게 함 */
    transform: translateY(60px); 
}

/* 캐릭터가 숨겨지는 순간, "펑" 애니메이션 실행 */
.plant-character.hidden .pot::after {
    animation: puff-effect 0.5s ease-out forwards;
}

/* 캐릭터 상태별 애니메이션 */
@keyframes idle-sway {
    0%, 100% { transform: rotate(0deg); }
    50% { transform: rotate(3deg); }
}

@keyframes thinking-bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
}

@keyframes happy-jump {
    0%, 100% { transform: translateY(0) scale(1); }
    50% { transform: translateY(-15px) scale(1.05) rotate(5deg); }
}

/* 상태 클래스 */
.plant-character.idle .plant {
    animation: idle-sway 4s ease-in-out infinite;
}

.plant-character.thinking .plant {
    animation: thinking-bounce 1.5s ease-in-out infinite;
}
.plant-character.thinking .eye {
    height: 3px; /* 눈을 가늘게 떠서 생각하는 표정 */
    transform: translateY(4px);
}

.plant-character.happy .plant {
    animation: happy-jump 0.8s ease-in-out infinite;
}
.plant-character.happy .eye {
    height: 12px;
    width: 12px;
    transform: translateY(-2px);
}


/* 식물 상세 정보 모달 */
.modal-wrapper {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.4s ease, visibility 0.4s ease;
}
.modal-wrapper.visible {
    opacity: 1;
    visibility: visible;
}

.plant-modal {
    background: var(--bg-cream);
    padding: 20px; /* 내부 여백을 살짝 줄입니다. */
    border-radius: 20px;
    width: 90%;
    max-width: 520px; /* 최대 너비를 줄여 더 작게 만듭니다. */
    position: relative;
    box-shadow: 0 20px 50px rgba(0,0,0,0.2);
    transform: scale(0.9);
    transition: transform 0.4s ease;
}

.plant-modal img {
    width: 100%;
    height: 200px; /* 이미지 높이를 줄여 모달 전체 크기를 줄입니다. */
    object-fit: cover;
    border-radius: 12px;
    margin-bottom: 20px;
}
.modal-wrapper.visible .plant-modal {
    transform: scale(1);
}

.plant-modal .close-button {
    position: absolute;
    top: 15px;
    right: 15px;
    background: none;
    border: none;
    font-size: 2rem;
    color: var(--text-dark);
    cursor: pointer;
}

.plant-modal .plant-info h2 {
    font-family: 'Playfair Display', serif;
    font-size: 2rem;
    color: var(--user-bubble-bg);
    margin: 0 0 10px;
}
.plant-modal .plant-info p {
    font-size: 1rem;
    line-height: 1.7;
    margin-bottom: 24px;
    color: var(--text-dark); /* [수정] 상세 설명 텍스트 색상 추가 */
}
.plant-modal .care-guide h3 {
    margin-bottom: 12px;
    font-size: 1.2rem;
    border-bottom: 2px solid var(--border-light);
    padding-bottom: 8px;
    color: var(--text-dark); /* [수정] '관리 방법' 제목 색상 추가 */
}
.plant-modal .care-details {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
}
.care-item {
    background: #fff;
    padding: 12px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    font-size: 0.95rem;
    color: var(--text-dark); /* [수정] 관리 항목 텍스트 색상 추가 */
}
.care-item span {
    font-size: 1.5rem;
    margin-right: 10px;
}

.difficulty-rating {
    margin-bottom: 16px;
    font-size: 1.5rem;
}

.difficulty-rating .star.filled {
    color: #FFC700; /* 채워진 별 색상 (노란색 계열) */
}

.difficulty-rating .star.empty {
    color: #E0E0E0; /* 비어있는 별 색상 (밝은 회색) */
}
/* ⬇️ 아래 내용을 <style> 태그 안에 추가하세요 ⬇️ */

.difficulty-label {
    color: var(--text-dark);
    font-size: 1rem;
    font-weight: 500;
    margin-right: 8px;
    vertical-align: middle; /* 별과 세로 정렬을 맞춥니다 */
}

/* 별 아이콘의 세로 정렬도 미세 조정합니다. */
.difficulty-rating .star {
    vertical-align: middle;
}

/* 화면이 작아질 때 캐릭터 위치 및 크기 조정 */
@media (max-width: 820px) {
 .plant-character {
  left: auto; /* 기존 left 속성 무효화 */
  right: 20px; /* 오른쪽에서 20px 위치 */
  bottom: 80px; /* 아래에서 20px 위치 */
  transform: scale(0.8); /* 크기를 80%로 축소 */
        transform-origin: bottom right; /* 오른쪽 아래를 기준으로 작아지도록 설정 */
  }

    main {
    padding-bottom: 90px !important; /* 네비게이션 높이+여유 */
  }
  .chat-container {
    max-width: 100vw;
    min-height: 60vh;
    margin-bottom: 80px; /* 하단 네비게이션 만큼 여유 공간 */
  }
  .message-area {
    padding-bottom: 35px; /* 옵션버튼이 겹치지 않게 */
  }
}

/* 푸터 전용 스타일 */
    .main-footer {
        background-color: var(--bg-cream);
        color: var(--text-dark);
        padding: 50px 20px 20px;
        border-top: 1px solid #e9e6e6;
        font-size: 0.95rem;
    }
    .footer-container {
        max-width: 900px;
        margin: 0 auto;
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        gap: 40px;
        padding-bottom: 40px;
        border-bottom: 1px solid #e0dcd1;
    }
    .footer-about {
        max-width: 300px;
    }
    .footer-about .logo {
        font-family: var(--font-serif);
        font-size: 1.8rem;
        font-weight: 600;
        color: var(--primary-green);
        text-decoration: none;
        margin-bottom: 12px;
        display: inline-block;
    }
    .footer-about p {
        line-height: 1.7;
        color: #7a7a5c;
        margin-bottom: 20px;
    }
    .footer-social a {
        color: #7a7a5c;
        text-decoration: none;
        margin-right: 18px;
        transition: color 0.2s;
    }
    .footer-social a:hover {
        color: var(--primary-green);
    }
    .footer-links-group {
        display: flex;
        gap: 50px;
    }
    .footer-links h4 {
        font-family: var(--font-serif);
        color: var(--text-dark);
        font-size: 1.2rem;
        margin-bottom: 15px;
    }
    .footer-links ul {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    .footer-links li {
        margin-bottom: 10px;
    }
    .footer-links a {
        color: #7a7a5c;
        text-decoration: none;
        transition: color 0.2s;
    }
    .footer-links a:hover {
        color: var(--primary-green);
        text-decoration: underline;
    }
    .footer-bottom {
        text-align: center;
        padding-top: 20px;
        font-size: 0.85rem;
        color: #b2a97e;
    }
    /* 푸터 하단 및 사업자 정보 스타일 */
.business-info {
    font-size: 0.8rem;
    color: #908976; /* 기존보다 약간 더 잘 보이는 색상 */
    line-height: 1.7;
    margin-bottom: 20px;
}

.business-info strong {
    color: #7a7a5c;
    font-weight: 500;
}

.business-info p {
    margin: 0;
}

/* 기존 저작권 텍스트의 클래스명을 추가하여 스타일을 명확히 함 */
.copyright-text {
    font-size: 0.85rem;
    color: #b2a97e;
    margin: 0;
}

    @media (max-width: 768px) {
        .footer-container {
            flex-direction: column;
            text-align: center;
        }
        .footer-about {
            max-width: 100%;
        }
        .footer-social {
            margin-bottom: 20px;
        }
        .footer-links-group {
            width: 100%;
            justify-content: space-around;
            text-align: center;
        }
            .business-info {
        font-size: 0.75rem; /* 모바일에서 글자 크기 살짝 줄임 */
    }
    }
</style>
</head>

<body>
    
    
    <header id="main-header">
                            <a href="index.html" class="logo">
            <img src="logo.png" alt="오후의 식물 로고">
            <span>오후의 식물</span>
        </a>
        <nav>
            <a href="index.html">홈</a>
            <a href="story.html">초록 이야기</a>
            <a href="myPlant.html">나의 식물</a>
            <a href="findPlant.html">식물 상담소</a>
            <a href="payment.html">구독하기</a>
            <a href="#" class="cta-button">Login</a>
        </nav>
    </header>

    <main>
        <div id="plant-character" class="plant-character idle">
            <div class="pot">
                <div class="eyes">
                    <div class="eye"></div>
                    <div class="eye"></div>
                </div>
            </div>
            <div class="plant">
                <div class="leaf leaf-1"></div>
                <div class="leaf leaf-2"></div>
                <div class="leaf leaf-3"></div>
            </div>
        </div>


        <div class="chat-container">

        <div class="message-area" id="message-area">
          </div>
        <div class="option-area" id="option-area">
          <div class="option-buttons" id="option-buttons">
            </div>
        </div>
      </div>
    </main>

        <div id="plant-modal-wrapper" class="modal-wrapper">
    <div id="plant-modal-content" class="plant-modal">
        <button class="close-button">&times;</button>
        <img id="plant-modal-img" src="" alt="추천 식물 이미지">
        <div class="plant-info">
            <h2 id="plant-modal-name"></h2>
            <div id="plant-modal-difficulty" class="difficulty-rating"></div>
            <p id="plant-modal-desc"></p>
            <div class="care-guide">
                <h3>🌿 관리 방법</h3>
                <div id="plant-modal-care" class="care-details">
                    </div>
            </div>
        </div>
    </div>
</div>

    <div class="modal-wrapper" id="limit-modal">
        <div class="plant-modal" style="max-width: 450px; text-align: center;">
            <button class="close-button" id="close-limit-modal">&times;</button>
            <div class="plant-info">
                <h2 style="font-size: 1.6rem;">📸 월간 사용량 초과</h2>
                <p style="font-size: 1.1rem; color: var(--text-dark); line-height: 1.7;">
                    무료 플랜의 사진 분석 기능(이름 찾기, 진단)을 모두 사용했어요.<br>
                    <strong>'오후의 식물 Pro'</strong>를 구독하고 모든 기능을 무제한으로 이용해보세요!
                </p>
                 <div class="modal-actions" style="justify-content: center; margin-top: 1rem; gap: 1rem;">
                    <button class="modal-btn secondary" id="cancel-limit-modal">다음에 할게요</button>
                    <button class="modal-btn primary" id="confirm-limit-modal">Pro 플랜 보기</button>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-wrapper" class="modal-wrapper">
        <div class="modal">
            <div class="modal-left"></div>
            <div class="modal-right">
                <button class="close-button">&times;</button>
                <div id="login-form" class="form-container">
                    <div class="form-header">
                        <a href="index.html" class="logo">오후의 식물</a>
                        <h2>Welcome Back</h2>
                    </div>
                    <form>
                        <div class="input-group">
                            <label for="login-email">Email</label>
                            <input type="email" id="login-email" required>
                        </div>
                        <div class="input-group">
                            <label for="login-password">Password</label>
                            <input type="password" id="login-password" required>
                        </div>
                        <button type="submit" class="cta-button">Login</button>
                    </form>
                    <p class="form-switcher">
                        Don't have an account? <a href="#" id="show-signup">Sign Up</a>
                    </p>
                </div>

                <div id="signup-form" class="form-container" style="display: none;">
                    <div class="form-header">
                        <a href="index.html" class="logo">오후의 식물</a>
                        <h2>Create Account</h2>
                    </div>
                    <form>
                        <div class="input-group">
                            <label for="signup-name">Name</label>
                            <input type="text" id="signup-name" required>
                        </div>
                        <div class="input-group">
                            <label for="signup-email">Email</label>
                            <input type="email" id="signup-email" required>
                        </div>
                        <div class="input-group">
                            <label for="signup-password">Password</label>
                            <input type="password" id="signup-password" required>
                        </div>
                        <div class="agreement-group">
    <div class="checkbox-group">
        <input type="checkbox" id="signup-terms" name="terms" required>
        <label for="signup-terms">
            [필수] <a href="terms.html" target="_blank">이용약관</a>에 동의합니다.
        </label>
    </div>
    <div class="checkbox-group">
        <input type="checkbox" id="signup-privacy" name="privacy" required>
        <label for="signup-privacy">
            [필수] <a href="privacy.html" target="_blank">개인정보처리방침</a>에 동의합니다.
        </label>
    </div>
</div>

<button type="submit" class="cta-button">Create Account</button>
                    </form>
                    <p class="form-switcher">
                        Already have an account? <a href="#" id="show-login">Login</a>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <footer class="main-footer">
    <div class="footer-container">
        <div class="footer-about">
            <a href="index.html" class="logo">오후의 식물</a>
            <p>식물과 함께하는 모든 순간이 더 행복하고 의미 있도록, 오후의 식물이 당신의 초록빛 여정에 함께합니다.</p>
            <div class="footer-social">
                <a href="https://www.instagram.com/plantnoon/" target="_blank">Instagram</a>
                <a href="https://blog.naver.com/happy_care_service/223955159263" target="_blank">Blog</a>
                <a href="https://open.kakao.com/o/gJLPjuKh" target="_blank">Open Chat</a>
            </div>
        </div>
        <div class="footer-links-group">
            <div class="footer-links">
                <h4>Policy</h4>
                <ul>
                    <li><a href="terms.html">이용약관</a></li>
                    <li><a href="privacy.html">개인정보처리방침</a></li>
                    <li><a href="refund.html">환불정책</a></li>
                </ul>
            </div>
        </div>
    </div>
    <div class="footer-bottom">
        <div class="business-info">
            <p>
                상호명: 고하이어(GoHigher) | 대표자명: 박해진 | 사업자등록번호: 407-09-54622<br>
                주소: 대구광역시 북구 동천로 155, 101동 1202호 | 대표전화번호: 070-8080-1675
            </p>
        </div>
        <p>&copy; 2025 Plantnoon. All Rights Reserved.</p>
    </div>
</footer>


<nav id="bottom-nav">
  <a href="index.html" class="nav-item">
    <span class="nav-icon">🏠</span>
  </a>
  <a href="story.html" class="nav-item">
    <span class="nav-icon">🌱</span>
  </a>
  <a href="myPlant.html" class="nav-item">
    <span class="nav-icon">🪴</span>
  </a>
  <a href="findPlant.html" class="nav-item">
    <span class="nav-icon">💬</span>
  </a>
    <a href="payment.html" class="nav-item">
    <span class="nav-icon">⭐</span>
  </a>
</nav>

<div id="user-status-modal" style="display:none; position:fixed; z-index:9999; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.5); align-items:center; justify-content:center;">
    <div style="background:#fff; border-radius:16px; max-width:380px; width:90%; margin:auto; box-shadow:0 10px 40px rgba(0,0,0,0.12); position:relative; text-align:center; padding: 30px;">
        
        <button id="close-status-modal" style="position:absolute; top:12px; right:15px; font-size:2rem; color:#aaa; background:none; border:none; cursor:pointer; line-height:1;">&times;</button>
        
        <div style="margin-bottom:20px;">
            <h3 style="font-family: 'Playfair Display', serif; font-size:1.8rem; margin:10px 0 8px 0; color:#3a593b;">내 구독 정보</h3>
            <p style="font-size:1rem; color:#777;">현재 구독 중인 플랜의 정보입니다.</p>
        </div>

        <div id="subscription-info" style="background-color:#f8f7f4; border-radius:10px; padding:25px; margin-bottom:25px; text-align:left;">
            <p style="margin:0; text-align:center;">구독 정보를 불러오는 중...</p>
        </div>
        
        <button id="logout-button" style="width:100%; padding:14px; border:none; background-color:#e0e0e0; color:#333; border-radius:8px; font-size:1rem; font-weight:700; cursor:pointer;">로그아웃</button>
    </div>
</div>

    <script type="module" src="navigation.js"></script>

<script type="module">
    // navigation.js에서 auth, db 객체 가져오기
    import { auth, db } from './navigation.js';
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";


document.addEventListener('DOMContentLoaded', () => {
    const plantModalWrapper = document.getElementById('plant-modal-wrapper');
    const plantModalContent = document.getElementById('plant-modal-content');
    const closeModalButton = plantModalContent.querySelector('.close-button');
    const plantModalImg = document.getElementById('plant-modal-img');
    const plantModalName = document.getElementById('plant-modal-name');
    const plantModalDesc = document.getElementById('plant-modal-desc');
    const plantModalCare = document.getElementById('plant-modal-care');
    const plantModalDifficulty = document.getElementById('plant-modal-difficulty');
    const messageArea = document.getElementById('message-area');
    const optionButtonsContainer = document.getElementById('option-buttons');
    const plantCharacter = document.getElementById('plant-character');
    let currentStep = 0;
    const userAnswers = {};
    
    // 👈 [NEW] Pro 플랜 및 사용량 관련 변수 추가
    let currentUser = null;
    let isProUser = false;
    let photoUsageCount = 0;
    let usageMonth = '';

    onAuthStateChanged(auth, async (user) => {
        currentUser = user; 
        if (user) {
            // Firestore에서 사용자 프로필(proPlan 및 사용량 포함) 가져오기
            const userDocRef = doc(db, "users", user.uid);
            const userDocSnap = await getDoc(userDocRef);

            if (userDocSnap.exists()) {
                const userData = userDocSnap.data();
                isProUser = userData.proPlan === true;
                photoUsageCount = userData.photoUsageCount || 0;
                usageMonth = userData.usageMonth || '';
            } else {
                console.log("사용자 문서를 찾을 수 없습니다. 무료 플랜으로 간주합니다.");
                isProUser = false;
                photoUsageCount = 0;
                usageMonth = '';
            }
        } else {
            // 로그아웃 시 상태 초기화
            isProUser = false;
            photoUsageCount = 0;
            usageMonth = '';
        }
    });

    const questions = [
        { 
            key: 'intro', 
            text: "안녕! 만나서 반가워. 무엇을 도와줄까?",
            options: [
                { text: '나에게 맞는 식물 추천받기 🌿', value: 'start_recommendation' },
                { text: '사진으로 식물 이름 찾기 📸', value: 'start_identification' },
                { text: '아픈 식물 진단받기 🩺', value: 'start_diagnosis' }
            ]
        },
        { 
            key: 'light', 
            text: "좋아! 먼저, 식물을 둘 공간의 빛은 어떤 편이야?", 
            options: [ 
                { text: '창문이 없거나 멀어 (어두운 편)', value: 'low' }, 
                { text: '햇빛 드는 창가 근처 (밝은 편)', value: 'medium' }, 
                { text: '직사광선이 4시간 이상 (매우 밝음)', value: 'high' } 
            ] 
        },
        {
            key: 'space',
            text: "식물을 놓을 공간은 얼마나 넓어?",
            options: [
                { text: '책상이나 선반 위 (소형)', value: 'small'},
                { text: '바닥에 둘 공간 (중형)', value: 'medium'},
                { text: '넓은 거실 한 켠 (대형)', value: 'large'}
            ]
        },
        {
            key: 'purpose',
            text: '식물을 키우려는 주된 이유가 뭐야?',
            options: [
                { text: '인테리어 효과! 🌿', value: 'interior' },
                { text: '공기 정화 능력', value: 'air_purification' },
                { text: '처음이라 키우기 쉬운 식물', value: 'beginner' },
                { text: '예쁜 꽃을 보고 싶어 🌸', value: 'flowering' }
            ]
        },
        { 
            key: 'pet', 
            text: "혹시 반려동물과 함께 살고 있어? 🐶", 
            options: [ 
                { text: '응, 같이 살아!', value: 'yes' }, 
                { text: '아니, 없어.', value: 'no' }, 
            ] 
        },
        { 
            key: 'watering_style', 
            text: "마지막! 너의 물주기 스타일은 어때?", 
            options: [ 
                { text: '깜빡 잊을 때가 많아 (건조하게)', value: 'low' }, 
                { text: '꼬박꼬박 챙겨주는 편 (보통)', value: 'medium' }, 
                { text: '애정 듬뿍! 자주 주고 싶어 (촉촉하게)', value: 'high' } 
            ] 
        },
        { 
            key: 'result', 
            text: "좋아, 다 됐어! 너의 성향을 분석해서 딱 맞는 친구들을 찾아볼게. 잠시만 기다려줘!", 
            options: null 
        }
    ];
    
    const plants = [
        { name: '산세베리아', light: 'low', watering_style: 'low', size: 'medium', pet_friendly: false, purpose: ['air_purification', 'beginner'], difficulty: 1, image: 'findPlant/산세베리아.webp', description: '공기 정화 능력이 탁월하며 건조에 강해 초보자에게 좋아요.', tip: '물을 너무 자주 주면 뿌리가 썩을 수 있어요. 흙이 완전히 마른 것을 확인한 후에 물을 주세요.' },
        { name: '스킨답서스', light: 'low', watering_style: 'medium', size: 'small', pet_friendly: false, purpose: ['beginner', 'air_purification'], difficulty: 1, image: 'findPlant/스킨답서스.webp', description: '생명력이 강해 어디서든 잘 자라는 덩굴 식물이에요.', tip: '잎 끝이 노랗게 변하면 과습의 신호일 수 있어요.' },
        { name: '몬스테라', light: 'medium', watering_style: 'medium', size: 'large', pet_friendly: false, purpose: ['interior', 'air_purification'], difficulty: 2, image: 'findPlant/몬스테라.webp', description: '멋진 잎 모양으로 인테리어 효과가 뛰어난 플랜테리어의 상징이죠.', tip: '새 잎에 구멍이 없다면, 빛이 부족하다는 신호일 수 있어요.' },
        { name: '선인장', light: 'high', watering_style: 'low', size: 'small', pet_friendly: true, purpose: ['beginner', 'interior'], difficulty: 2, image: 'findPlant/선인장.webp', description: '강한 햇빛을 좋아하고 물을 자주 주지 않아도 괜찮아요.', tip: '여름 성장기에는 한 달에 한 번, 겨울 휴면기에는 물을 거의 주지 않아도 돼요.' },
        { name: '칼라테아', light: 'medium', watering_style: 'high', size: 'medium', pet_friendly: true, purpose: ['interior'], difficulty: 4, image: 'findPlant/칼라테아.webp', description: '아름다운 잎 무늬를 가졌지만, 꾸준한 습도 관리가 필요해요.', tip: '수돗물보다는 정수된 물을 주면 잎 끝이 타는 것을 예방할 수 있어요.' },
        { name: '스파티필름', light: 'low', watering_style: 'high', size: 'medium', pet_friendly: false, purpose: ['air_purification', 'flowering'], difficulty: 2, image: 'findPlant/스파티필름.webp', description: '우아한 흰색 꽃이 피고, 실내 공기 정화에 탁월해요.', tip: '잎이 축 처지면 물이 필요하다는 신호랍니다. 물을 주면 금방 다시 쌩쌩해져요.' },
        { name: '거미 식물', light: 'medium', watering_style: 'medium', size: 'medium', pet_friendly: true, purpose: ['beginner', 'air_purification'], difficulty: 1, image: 'findPlant/거미식물.webp', description: '새끼 식물이 달리는 모습이 독특하며, 키우기 정말 쉬워요.', tip: '자라나는 새끼 식물을 잘라 물에 꽂아두면 쉽게 번식시킬 수 있어요.' },
        { name: '보스턴 고사리', light: 'medium', watering_style: 'high', size: 'medium', pet_friendly: true, purpose: ['interior'], difficulty: 3, image: 'findPlant/보스턴고사리.webp', description: '풍성한 잎이 매력적이며, 촉촉한 환경을 좋아해요.', tip: '건조한 실내 환경에서는 잎 주변에 자주 분무해주면 좋습니다.' },
        { name: '금전수(ZZ Plant)', light: 'low', watering_style: 'low', size: 'large', pet_friendly: false, purpose: ['beginner', 'air_purification'], difficulty: 1, image: 'findPlant/금전수.webp', description: '빛이 적은 곳에서도 잘 자라며, 물을 자주 주지 않아도 되어 관리가 편해요.', tip: '돈을 불러온다는 속설이 있어 개업 선물로 인기가 많아요.' },
        { name: '여인초', light: 'medium', watering_style: 'medium', size: 'large', pet_friendly: true, purpose: ['interior', 'beginner'], difficulty: 2, image: 'findPlant/여인초.webp', description: '넓고 시원한 잎이 매력적인 식물로, 이국적인 분위기를 연출해요.', tip: '잎이 마르지 않도록 주변에 분무해주면 더 건강하게 자라요.' },
        { name: '아레카야자', light: 'medium', watering_style: 'high', size: 'large', pet_friendly: true, purpose: ['air_purification', 'interior'], difficulty: 3, image: 'findPlant/아레카야자.webp', description: 'NASA가 선정한 실내 공기정화 식물 1위! 가습 효과도 뛰어나요.', tip: '물을 줄 때는 겉흙이 말랐을 때 흠뻑 주는 것이 좋습니다.' },
        { name: '필레아 페페로미오이데스', light: 'medium', watering_style: 'medium', size: 'small', pet_friendly: true, purpose: ['interior', 'beginner'], difficulty: 2, image: 'findPlant/필레아페페.webp', description: '동글동글한 잎이 귀여워 인기가 많고 번식력이 좋은 식물입니다.', tip: '새로운 잎이 잘 나도록 주기적으로 화분을 돌려 빛을 골고루 받게 해주세요.' },
        { name: '안스리움', light: 'medium', watering_style: 'high', size: 'medium', pet_friendly: false, purpose: ['flowering', 'interior'], difficulty: 3, image: 'findPlant/안스리움.webp', description: '하트 모양의 포엽과 독특한 꽃이 1년 내내 피고 지는 식물이에요.', tip: '반려동물에게는 독성이 있으니 섭취하지 않도록 주의가 필요해요.' },
        { name: '고무나무', light: 'medium', watering_style: 'low', size: 'large', pet_friendly: false, purpose: ['air_purification', 'beginner'], difficulty: 2, image: 'findPlant/고무나무.webp', description: '광택 있는 짙은 잎이 고급스러우며, 환경 적응력이 뛰어나요.', tip: '잎에 먼지가 쌓이면 젖은 천으로 닦아주면 광합성에 도움이 됩니다.' }
    ];

    function addMessage(text, sender, contentHTML = null) {
        const bubble = document.createElement('div');
        bubble.className = `message-bubble ${sender}-message`;
        if (contentHTML) {
            bubble.innerHTML = contentHTML;
        } else {
            bubble.innerHTML = text.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\n/g, '<br>');
        }
        messageArea.appendChild(bubble);
        messageArea.scrollTop = messageArea.scrollHeight;
        return bubble;
    }

    // ... (이하 모든 기존 함수들은 여기에 그대로 존재합니다) ...

    const footer = document.querySelector('.main-footer');
    const observerOptions = { root: null, rootMargin: '0px', threshold: 0.1 };
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                plantCharacter.classList.add('hidden');
            } else {
                plantCharacter.classList.remove('hidden');
            }
        });
    }, observerOptions);
    observer.observe(footer);

    function showTypingIndicator() {
        plantCharacter.className = 'plant-character thinking';
        const indicator = document.createElement('div');
        indicator.className = 'typing-indicator plant-message';
        indicator.innerHTML = '<span></span><span></span><span></span>';
        messageArea.appendChild(indicator);
        messageArea.scrollTop = messageArea.scrollHeight;
        return indicator;
    }

    function askQuestion() {
        const question = questions[currentStep];
        const indicator = showTypingIndicator();
        setTimeout(() => {
            messageArea.removeChild(indicator);
            addMessage(question.text, 'plant');
            if (question.key !== 'result') {
                plantCharacter.className = 'plant-character idle';
            }
            if (question.key === 'result') {
                showResults();
            } else {
                renderOptions(question.options);
            }
        }, 1200);
    }
    
    function renderOptions(options) {
        optionButtonsContainer.innerHTML = '';
        if (!options) return;
        options.forEach(opt => {
            const button = document.createElement('button');
            button.textContent = opt.text;
            button.dataset.value = opt.value;
            button.addEventListener('click', () => handleOptionClick(opt));
            optionButtonsContainer.appendChild(button);
        });
    }
    
    // 👈 [CHANGED] handleOptionClick을 async 함수로 변경하고 사용량 체크 로직 추가
    async function handleOptionClick(option) {
        if (currentStep === 0 && !currentUser) {
            document.querySelector('.cta-button').click();
            return;
        }

        const isPhotoFeature = option.value === 'start_identification' || option.value === 'start_diagnosis';

        if (isPhotoFeature) {
            const canProceed = await checkAndIncrementUsage();
            if (!canProceed) {
                openLimitModal();
                return;
            }
        }

        addMessage(option.text, 'user');
        userAnswers[questions[currentStep].key] = option.value;
        optionButtonsContainer.innerHTML = '';

        if (option.value === 'start_identification') {
            startImageIdentification();
            return;
        } else if (option.value === 'start_diagnosis') {
            startImageDiagnosis();
            return;
        }
        
        const currentKey = questions[currentStep].key;
        const reactions = {
            light: "빛은 식물에게 정말 중요하지! 알았어. ☀️",
            space: "공간 크기를 가늠해보는 중... 🤔",
            purpose: "그렇구나! 좋은 목표를 가졌네. 👍",
            pet: "알려줘서 고마워! 안전이 최우선이지. 🐾",
            watering_style: "물주기 스타일도 아주 중요한 정보야! 💧"
        };
        
        if (reactions[currentKey]) {
            setTimeout(() => {
                addMessage(reactions[currentKey], 'plant');
                proceedToNextStep();
            }, 500);
        } else {
            proceedToNextStep();
        }
    }

    // 👈 [NEW] 사용량 체크 및 DB 업데이트 함수
    async function checkAndIncrementUsage() {
        if (isProUser) return true; // Pro 유저는 항상 통과

        const currentMonthStr = new Date().toISOString().slice(0, 7); // "YYYY-MM" 형식

        if (usageMonth === currentMonthStr) {
            // 같은 달이면 사용량 체크
            if (photoUsageCount >= 3) {
                console.log("이번 달 사진 분석 사용량을 모두 소진했습니다.");
                return false; // 제한 도달
            }
            // 아직 사용 가능하면 카운트 증가
            const newCount = photoUsageCount + 1;
            await updateUserUsageInFirestore(newCount, currentMonthStr);
            photoUsageCount = newCount; // 로컬 상태 업데이트
            return true;
        } else {
            // 새로운 달이면 사용량 초기화
            console.log("새로운 달이 되어 사용량을 초기화합니다.");
            const newCount = 1;
            await updateUserUsageInFirestore(newCount, currentMonthStr);
            photoUsageCount = newCount; // 로컬 상태 업데이트
            usageMonth = currentMonthStr; // 로컬 상태 업데이트
            return true;
        }
    }

    // 👈 [NEW] Firestore에 사용량 업데이트하는 헬퍼 함수
    async function updateUserUsageInFirestore(count, month) {
        if (!currentUser) return;
        try {
            const userDocRef = doc(db, "users", currentUser.uid);
            await updateDoc(userDocRef, {
                photoUsageCount: count,
                usageMonth: month
            });
            console.log(`Firestore 사용량 업데이트 완료: ${count}회, ${month}`);
        } catch (error) {
            console.error("Firestore 사용량 업데이트 실패:", error);
        }
    }

    // 👈 [NEW] 사용량 제한 모달 관련 함수
    const limitModal = document.getElementById('limit-modal');
    function openLimitModal() {
        limitModal.classList.add('visible');
    }
    function closeLimitModal() {
        limitModal.classList.remove('visible');
    }
    document.getElementById('close-limit-modal').addEventListener('click', closeLimitModal);
    document.getElementById('cancel-limit-modal').addEventListener('click', closeLimitModal);
    document.getElementById('confirm-limit-modal').addEventListener('click', () => {
        window.location.href = 'payment.html';
    });


    function proceedToNextStep() {
        currentStep++;
        if (currentStep < questions.length) {
            askQuestion();
        }
    }
    
    function startImageIdentification() {
        addMessage("좋아! 궁금한 식물 사진을 올려줘.", 'plant');
        createImageUploadButton(handleImageUpload);
    }

    function startImageDiagnosis() {
        addMessage("좋아! 진단이 필요한 식물 사진을 올려줘.", 'plant');
        createImageUploadButton(handleImageUploadForDiagnosis);
    }
    
    function createImageUploadButton(handler) {
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.accept = 'image/*';
        fileInput.style.display = 'none';
        fileInput.addEventListener('change', handler);
        
        const uploadButton = document.createElement('button');
        uploadButton.textContent = '여기를 눌러 사진 선택하기';
        uploadButton.onclick = () => fileInput.click();
        
        optionButtonsContainer.innerHTML = '';
        optionButtonsContainer.appendChild(uploadButton);
        document.body.appendChild(fileInput); // DOM에 추가해야 클릭 이벤트가 동작
    }
    
    async function handleImageUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        optionButtonsContainer.innerHTML = '';
        addMessage("사진을 분석하고 있어. 잠시만 기다려줘! 🌱", 'plant');
        const indicator = showTypingIndicator();
        try {
            const compressedBlob = await resizeImage(file);
            const base64Image = await blobToBase64(compressedBlob);
            const response = await fetchWithRetry('/api/identify', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ image: base64Image, mimeType: compressedBlob.type })
            });
            indicator.remove();
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || `서버 응답 오류: ${response.statusText}`);
            }
            const data = await response.json();
            addMessage(data.identification, 'plant');
        } catch (apiError) {
            console.error("API 호출 오류:", apiError);
            indicator.remove();
            addMessage(`이런, 사진을 분석하는 중에 오류가 발생했어.\n(${apiError.message})`, 'plant');
        } finally {
            showRestartButton();
        }
    }
    
    async function handleImageUploadForDiagnosis(event) {
        const file = event.target.files[0];
        if (!file) return;
        optionButtonsContainer.innerHTML = '';
        addMessage("사진을 정밀 분석하고 있어. 잠시만 기다려줘! 🩺", 'plant');
        const indicator = showTypingIndicator();
        try {
            const compressedBlob = await resizeImage(file);
            const base64Image = await blobToBase64(compressedBlob);
            const response = await fetchWithRetry('/api/diagnose', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ image: base64Image, mimeType: compressedBlob.type })
            });
            indicator.remove();
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || `서버 응답 오류: ${response.statusText}`);
            }
            const data = await response.json();
            addMessage(data.diagnosis, 'plant');
        } catch (apiError) {
            console.error("API 호출 오류:", apiError);
            indicator.remove();
            addMessage(`이런, 진단하는 중에 오류가 발생했어.\n(${apiError.message})`, 'plant');
        } finally {
            showRestartButton();
        }
    }
    
    function blobToBase64(blob) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(blob);
            reader.onloadend = () => resolve(reader.result.split(',')[1]);
            reader.onerror = error => reject(error);
        });
    }

    function fetchWithRetry(url, options, retries = 3, delay = 1500) {
        return new Promise((resolve, reject) => {
            const attemptFetch = (n) => {
                fetch(url, options)
                    .then(response => {
                        if (response.status === 503 && n > 0) {
                            console.log(`서버 과부하 감지. ${delay/1000}초 후 다시 시도합니다... (남은 횟수: ${n-1})`);
                            setTimeout(() => attemptFetch(n - 1), delay);
                        } else {
                            resolve(response);
                        }
                    })
                    .catch(error => {
                        if (n > 0) {
                            setTimeout(() => attemptFetch(n - 1), delay);
                        } else {
                            reject(error);
                        }
                    });
            };
            attemptFetch(retries);
        });
    }

    function resizeImage(file) {
        return new Promise((resolve, reject) => {
            const MAX_WIDTH = 800;
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onerror = reject;
            reader.onload = (event) => {
                const img = new Image();
                img.src = event.target.result;
                img.onerror = reject;
                img.onload = () => {
                    if (img.width <= MAX_WIDTH) {
                        return resolve(file); // 리사이즈 불필요
                    }
                    const canvas = document.createElement('canvas');
                    const scale = MAX_WIDTH / img.width;
                    canvas.width = MAX_WIDTH;
                    canvas.height = img.height * scale;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    canvas.toBlob((blob) => {
                        if(blob) resolve(blob);
                        else reject(new Error('Canvas to Blob conversion failed'));
                    }, 'image/jpeg', 0.8);
                };
            };
        });
    }

    function showRestartButton() {
        setTimeout(() => {
            const restartButton = document.createElement('button');
            restartButton.textContent = '처음으로 돌아가기';
            restartButton.addEventListener('click', () => {
                messageArea.innerHTML = '';
                currentStep = 0;
                Object.keys(userAnswers).forEach(k => delete userAnswers[k]);
                plantCharacter.className = 'plant-character idle';
                askQuestion();
            });
            optionButtonsContainer.innerHTML = '';
            optionButtonsContainer.appendChild(restartButton);
        }, 1000);
    }


    function showResults() {
        const filteredByPet = userAnswers.pet === 'yes' ? plants.filter(plant => plant.pet_friendly) : plants;
        const rankedPlants = filteredByPet.map(plant => {
            let score = 0;
            if (plant.light === userAnswers.light) { score += 5; } 
            else if ((userAnswers.light === 'high' && plant.light === 'low') || (userAnswers.light === 'low' && plant.light === 'high')) { score -= 5; }
            if (plant.watering_style === userAnswers.watering_style) score += 3;
            if (plant.purpose.includes(userAnswers.purpose)) score += 2;
            if (plant.size === userAnswers.space) score += 1;
            return { ...plant, score };
        }).sort((a, b) => b.score - a.score);
        
        const topPlants = rankedPlants.slice(0, 2);

        if (topPlants.length === 0 || topPlants[0].score < 1) { 
            plantCharacter.className = 'plant-character idle';
            addMessage("아쉽게도 모든 조건에 딱 맞는 친구를 찾지 못했어. 조건을 조금 바꿔서 다시 시도해볼래?", 'plant');
        } else {
            plantCharacter.className = 'plant-character happy';
            addMessage("너에게 어울리는 식물 친구들을 찾았어!", 'plant');
            topPlants.forEach(p => {
                let reason = '';
                if (p.light === userAnswers.light) reason = '빛 조건이 딱 맞고, ';
                else if (p.purpose.includes(userAnswers.purpose)) reason = '원하는 목적에 잘 맞고, ';
                
                const contentHTML = `<div class="result-card-wrapper"><img src="${p.image}" alt="${p.name}"><h3>${p.name}</h3><p>${reason}${p.description.substring(0, 30)}...</p></div>`;
                
                const cardBubble = addMessage(null, 'plant', contentHTML);
                cardBubble.querySelector('.result-card-wrapper').addEventListener('click', () => {
                    openPlantDetailModal(p);
                });
            });
        }
        showRestartButton();
    }


    function openPlantDetailModal(plant) {
        plantModalImg.src = plant.image;
        plantModalImg.alt = plant.name;
        plantModalName.textContent = plant.name;
        plantModalDesc.textContent = plant.description;

        let starsHTML = '<span class="difficulty-label">난이도</span>'; 
        for (let i = 1; i <= 5; i++) {
            starsHTML += `<span class="star ${i <= plant.difficulty ? 'filled' : 'empty'}">${i <= plant.difficulty ? '★' : '☆'}</span>`;
        }
        plantModalDifficulty.innerHTML = starsHTML;

        const careInfo = {
            '☀️ 빛': { 'low': '어두운 곳 선호', 'medium': '밝은 간접광', 'high': '직사광선 필요' }[plant.light],
            '💧 물주기': { 'low': '건조하게 관리', 'medium': '흙 마르면 듬뿍', 'high': '항상 촉촉하게' }[plant.watering_style],
            '📏 크기': { 'small': '소형', 'medium': '중형', 'large': '대형' }[plant.size],
            '🐾 반려동물': plant.pet_friendly ? '안전해요' : '주의 필요'
        };

        plantModalCare.innerHTML = '';
        for (const [key, value] of Object.entries(careInfo)) {
            const item = document.createElement('div');
            item.className = 'care-item';
            const icon = key.split(' ')[0];
            const title = key.split(' ')[1];
            item.innerHTML = `<span>${icon}</span> <div><strong>${title}</strong><br>${value}</div>`;
            plantModalCare.appendChild(item);
        }

        if (plant.tip) {
            const tipItem = document.createElement('div');
            tipItem.className = 'care-item';
            tipItem.style.gridColumn = '1 / -1';
            tipItem.innerHTML = `<span>💡</span> <div><strong>Pro Tip</strong><br>${plant.tip}</div>`;
            plantModalCare.appendChild(tipItem);
        }
        
        plantModalWrapper.classList.add('visible');
    }

    function closePlantDetailModal() {
        plantModalWrapper.classList.remove('visible');
    }
    closeModalButton.addEventListener('click', closePlantDetailModal);
    plantModalWrapper.addEventListener('click', (e) => {
        if (e.target === plantModalWrapper) {
            closePlantDetailModal();
        }
    });

    askQuestion();
});


// ==========================================================
// 📍 2단계: ~~집사님 버튼에 대한 모달 띄우는 거임. 네비게이션.js에 넣으니깐 오류 나서 따로 넣음
// ==========================================================

document.addEventListener('DOMContentLoaded', function () {
    const db = firebase.firestore();
    const auth = firebase.auth();

    // 네비게이션의 로그인/내 정보 버튼
    // ❗️주의: 실제 프로젝트의 로그인 버튼 선택자(selector)로 변경해야 합니다.
    const userStatusButton = document.querySelector('header nav a.cta-button'); 

    // '내 정보' 모달 관련 요소들
    const userStatusModal = document.getElementById('user-status-modal');
    const closeStatusModal = document.getElementById('close-status-modal');
    const subscriptionInfoDiv = document.getElementById('subscription-info');
    const logoutButton = document.getElementById('logout-button');

    // 인증 상태 변경 감지
    auth.onAuthStateChanged(user => {
        if (user) {
            // --- 로그인 상태일 때 ---
            
            userStatusButton.addEventListener('click', e => {
                e.preventDefault(); // 기본 링크 이동 방지
                
                // Firestore에서 사용자 구독 정보 가져오기
                db.collection('users').doc(user.uid).get().then(doc => {
                    if (doc.exists && doc.data().proPlan) {
                        // Pro 구독자일 경우
                        const subData = doc.data();
                        
                        // Firestore Timestamp를 JavaScript Date 객체로 변환
                        const expiresAtDate = subData.subscriptionExpiresAt.toDate();
                        
                        // 날짜를 'YYYY년 MM월 DD일' 형식으로 포맷팅
                        const formattedDate = `${expiresAtDate.getFullYear()}년 ${expiresAtDate.getMonth() + 1}월 ${expiresAtDate.getDate()}일`;

                        // 모달에 정보 표시
                        subscriptionInfoDiv.innerHTML = `
                            <div style="font-size: 1rem; color: #555;">
                                <p style="margin:0 0 15px 0;"><strong>플랜:</strong> <span style="color:#3a593b; font-weight:bold;">Pro</span></p>
                                <p style="margin:0;"><strong>다음 결제 예정일:</strong> <span style="color:#3a593b; font-weight:bold;">${formattedDate}</span></p>
                            </div>
                        `;
                    } else {
                        // 무료 이용자일 경우
                        subscriptionInfoDiv.innerHTML = '<p style="margin:0;"><strong>플랜:</strong> Free</p>';
                    }
                }).catch(error => {
                    console.error("사용자 정보 조회 실패:", error);
                    subscriptionInfoDiv.innerHTML = '<p>정보를 불러오는 데 실패했습니다.</p>';
                });

                userStatusModal.style.display = 'flex'; // 모달 열기
            });

        } else {
            // --- 로그아웃 상태일 때 ---
            userStatusButton.textContent = "Login";
            // 여기에 기존 로그인 모달을 여는 이벤트를 다시 연결해야 할 수 있습니다.
        }
    });

    // '내 정보' 모달 닫기
    closeStatusModal.addEventListener('click', () => {
        userStatusModal.style.display = 'none';
    });

    // 모달 내 로그아웃 버튼
    logoutButton.addEventListener('click', () => {
        auth.signOut().then(() => {
            alert('로그아웃 되었습니다.');
            window.location.reload();
        });
    });
});
</script>
</body>
</html>