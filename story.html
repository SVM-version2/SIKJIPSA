<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- ✅ 메타 SEO -->
    <title>식물 이야기 | 테라리움과 식집사의 공간</title>
    <meta name="description" content="식물, 테라리움, 식집사 이야기부터 인테리어 팁까지 한눈에!">
    <meta name="keywords" content="식물, 테라리움, 식집사, 인테리어화분, 플랜테리어, 오후의 식물, 반려식물, 미니식물">

    <!-- ✅ OpenGraph (SNS 미리보기) -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="식물 이야기 | 테라리움과 식집사의 공간">
    <meta property="og:description" content="테라리움과 식물 인테리어 아이디어, 식집사의 이야기를 만나보세요.">
    <meta property="og:image" content="https://plantnoon.com/logo.png">
    <meta property="og:url" content="https://plantnoon.com/story.html">

    <!-- ✅ Twitter 카드 -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="식물 이야기 | 테라리움과 식집사의 공간">
    <meta name="twitter:description" content="테라리움과 식물 인테리어, 초록 감성을 전하는 오후의 식물">
    <meta name="twitter:image" content="https://plantnoon.com/logo.png">

    <link rel="icon" href="logo.png?v=2" type="image/png">

    <!-- 폰트 및 네비게이션 CSS -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="navigation.css">

 <style>
    /* 전체 콘텐츠를 감싸는 래퍼 */
.main-wrapper {
    display: flex;
    justify-content: center;
    align-items: flex-start;
    gap: 24px;
    max-width: 900px;
    margin: 100px auto 40px;
    padding: 0 16px;
}

.left-sidebar {
    width: 300px;
    position: sticky; /* 스크롤해도 따라오도록 */
    top: 100px;
    flex-shrink: 0;
}

.story-container {
    max-width: 480px;
    margin: 0; /* 기존 마진 제거 */
    width: 100%;
}

/* 퀴즈 위젯 카드 */
.quiz-widget {
    background: #fff;
    border-radius: 18px;
    padding: 24px;
    border: 1px solid #e9e6e6;
    box-shadow: 0 4px 16px rgba(48,60,33,0.07);
}
.quiz-widget h3 {
    margin: 0 0 16px;
    font-family: var(--font-serif);
    color: var(--primary-green);
    font-size: 1.4rem;
    text-align: center;
}
.quiz-widget .question {
    font-size: 1.05rem;
    line-height: 1.6;
    margin: 0 0 20px;
    color: #333;
    font-weight: 500;
}
.quiz-widget .options {
    display: flex;
    flex-direction: column;
    gap: 12px;
}
.quiz-widget .option {
    border: 1.5px solid #ddd;
    border-radius: 12px;
    padding: 12px 16px;
    font-size: 0.95rem;
    cursor: pointer;
    transition: all 0.2s ease-in-out;
    background: #fff;
    text-align: left;
    width: 100%;
}
.quiz-widget .option:hover {
    border-color: var(--primary-green);
    background: #f8fbf6;
}
/* 퀴즈 정답/오답 스타일 */
.quiz-widget .option.correct {
    background-color: #e8f5e9; /* Greenish */
    border-color: #4caf50;
    color: #2e7d32;
    font-weight: bold;
}
.quiz-widget .option.incorrect {
    background-color: #ffebee; /* Reddish */
    border-color: #f44336;
    color: #c62828;
    font-weight: bold;
}
.quiz-widget .option.disabled {
    pointer-events: none;
    opacity: 0.7;
}
.quiz-widget .feedback {
    margin: 18px 0 0;
    font-size: 0.9rem;
    line-height: 1.5;
    color: #444;
    padding: 12px;
    border-radius: 8px;
    background-color: #f5f5f5;
}

/* 반응형: 화면이 좁아지면 퀴즈 위젯을 피드 위로 이동 */
@media (max-width: 820px) {
    .main-wrapper {
        flex-direction: column;
        align-items: center;
    }
    .left-sidebar {
        position: static;
        width: 100%;
        max-width: 480px;
        margin-bottom: 24px;
    }
}
.story-container {
    max-width: 480px;
    margin: 100px auto 40px;
    padding: 0 8px;
    background: transparent;
}

/* ===== 플로팅 버튼 (글쓰기) ===== */
.write-btn {
    position: fixed; right: 26px; bottom: 75px; z-index: 999;
    background: linear-gradient(135deg, #8AD14D 30%, #355F19 100%);
    box-shadow: 0 6px 24px rgba(80,100,70,0.18);
    width: 63px; height: 63px; font-size: 2.6rem; border-radius: 50%;
    color: #fff; border: none;
    display: flex; align-items: center; justify-content: center;
    transition: background 0.21s, box-shadow 0.22s;
}
.write-btn:hover {
    background: linear-gradient(135deg, #355F19 50%, #8AD14D 100%);
    box-shadow: 0 12px 32px rgba(80,100,70,0.25);
    transform: scale(1.07);
}
    /* === 게시물 피드 및 카드 디자인 개선 (가장 중요!) === */
    #post-feed {
        display: flex;
        flex-direction: column;
        gap: 24px;
    }
/* ===== 인스타그램 스타일 피드 카드 ===== */
.post-card {
    background: #fff;
    border-radius: 22px;
    margin-bottom: 34px;
    box-shadow: 0 4px 24px rgba(48,60,33,0.10);
    overflow: hidden;
    transition: box-shadow 0.25s, transform 0.23s;
    border: 1.5px solid #e3e6e1;
    position: relative;
}

.post-card:hover {
    box-shadow: 0 8px 32px rgba(48,60,33,0.13);
    transform: translateY(-2px) scale(1.02);
}
/* ===== 카드 컨텐츠 ===== */
.post-card-content {
    padding: 24px 22px 22px;
}
 /* ===== 작성자/프로필 ===== */
.post-header {
    display: flex;
    align-items: center;
    gap: 11px;
    margin-bottom: 12px;
}
.post-author-avatar {
    width: 38px; height: 38px;
    border-radius: 50%;
    background-color: #A1B793;
    color: #fff; font-weight: bold; font-size: 1.2rem;
    display: flex; justify-content: center; align-items: center;
    border: 2px solid #D4E0C1;
}
.post-author-info {
    display: flex; flex-direction: column;
}
.post-author { font-weight: 700; font-size: 1.02rem; color: #4D5B40;}
.post-date { font-size: 12px; color: #B0B6A9; }
/* ===== 글 내용 ===== */
.post-content {
    font-size: 1.1rem; line-height: 1.6;
    margin: 4px 0 0 0;
    color: #364426;
    word-break: break-word;
}

    /* === 글쓰기 모달창 디자인 개선 === */
    .story-modal-wrapper {
        position: fixed;
        z-index: 999;
        left: 0; top: 0; width: 100vw; height: 100vh;
        background: rgba(30,30,30,0.45);
        display: flex; justify-content: center; align-items: center;
        opacity: 0; visibility: hidden;
        transition: opacity 0.4s;
        backdrop-filter: blur(3px);
    }
    .story-modal-wrapper.open {
        opacity: 1; visibility: visible;
    }
    .story-modal {
        background: #fff;
        border-radius: 14px;
        padding: 36px 40px;
        width: 90vw;
        max-width: 480px; /* 너비 조정 */
        box-shadow: 0 16px 36px rgba(80,80,80,0.13);
        transform: translateY(50px) scale(0.96);
        opacity: 0;
        transition: all 0.36s cubic-bezier(.52,1.85,.57,.99);
    }
    .story-modal-wrapper.open .story-modal {
        transform: translateY(0) scale(1); opacity: 1;
    }
    .story-modal h2 {
        margin-top: 0;
        text-align: center;
        color: var(--primary-green);
        font-family: var(--font-serif);
        font-size: 1.8rem;
        margin-bottom: 24px;
    }
    .story-modal textarea {
        width: 100%;
        min-height: 120px;
        resize: vertical;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 1rem;
        padding: 14px;
        margin-bottom: 18px;
        font-family: inherit;
        transition: border-color 0.2s, box-shadow 0.2s;
    }
    .story-modal textarea:focus {
        outline: none;
        border-color: var(--primary-green);
        box-shadow: 0 0 0 3px rgba(107, 123, 97, 0.2);
    }
    .story-modal .modal-actions {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 6px;
    }
    .story-modal button {
        border: none;
        border-radius: 8px;
        padding: 10px 24px;
        font-size: 1rem;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.2s;
    }
    .story-modal button[type="submit"] {
        background: var(--primary-green);
        color: #fff;
    }
    .story-modal button[type="submit"]:hover {
        background: #5a6950;
    }
    /* 취소 버튼은 중요도를 낮춤 */
    .story-modal button[type="button"] {
        background: #f0f0f0;
        color: #555;
    }
    .story-modal button[type="button"]:hover {
        background: #e0e0e0;
    }
    /* === 글쓰기 모달 디자인 개선 (수정 및 추가) === */

/* 모달 헤더 (새로 추가) */
.story-modal-header {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    margin-bottom: 24px;
    color: var(--primary-green);
}
.story-modal-header svg {
    /* 아이콘 색상 및 크기 조절 */
    stroke: var(--primary-green);
}
.story-modal h2 {
    margin: 0; /* 기존 마진 제거 */
    font-size: 1.7rem; /* 살짝 조정 */
}

/* 텍스트 입력 영역 */
.story-modal textarea {
    min-height: 150px; /* 최소 높이 살짝 늘리기 */
    margin-bottom: 8px; /* 카운터와의 간격 조정 */
}

/* 글자 수 카운터 (새로 추가) */
.char-counter {
    text-align: right;
    font-size: 0.85rem;
    color: #aaa;
    margin-bottom: 18px;
    padding-right: 5px;
}

/* '올리기' 버튼에 로딩 상태를 위한 스타일 추가 */
.story-modal button[type="submit"].loading {
    background: #5a6950;
    cursor: wait; /* 커서를 대기 모양으로 */
}


/* ===== 기존 CSS 코드 아래에 추가 ===== */

/* ===== 게시물 액션 버튼 (좋아요, 댓글) ===== */
.post-actions {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 8px 22px 14px;
    border-top: 1px solid #f0f2ee;
}
.action-btn {
    background: none;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 0.95rem;
    color: #555;
    padding: 6px;
    border-radius: 8px;
    transition: background 0.2s, color 0.2s;
}
.action-btn:hover {
    background: #f4f5f4;
}
.action-btn svg {
    width: 22px; height: 22px;
    stroke: #555;
    transition: all 0.2s;
}
/* 좋아요 버튼 눌렀을 때 스타일 */
.action-btn.liked svg {
    stroke: #e74c3c;
    fill: #e74c3c;
}
.action-btn.liked {
    color: #e74c3c;
}

/* ===== 댓글 섹션 ===== */
/* ===== 댓글 섹션 ===== */
.comments-section {
    padding: 0 22px 20px;
    background-color: #fcfcfb;
    border-top: 1px solid #f0f2ee;
}

/* 댓글 목록 */
.comments-list {
    margin-top: 20px;
    margin-bottom: 20px; /* 입력창과의 간격 추가 */
    display: flex;
    flex-direction: column;
    gap: 14px;
}
.comment {
    display: flex;
    gap: 8px;
    font-size: 0.9rem;
    align-items: flex-start;
}
.comment-author {
    font-weight: bold;
    color: #4D5B40;
    flex-shrink: 0;
}
.comment-text {
    color: #364426;
    word-break: break-word;
    line-height: 1.5;
}
.comment-date {
    font-size: 0.8rem;
    color: #aaa;
    margin-left: auto;
    flex-shrink: 0;
    padding-left: 10px;
}

/* === 댓글 입력창 디자인 개선 === */
.comment-input-area {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-top: 16px;
}
.comment-user-avatar {
    width: 34px; height: 34px;
    border-radius: 50%;
    background-color: #A1B793;
    color: #fff; font-weight: bold; font-size: 1rem;
    display: flex; justify-content: center; align-items: center;
    flex-shrink: 0;
}
.comment-user-avatar.disabled {
    background-color: #d1d1d1;
}
.comment-input-wrapper {
    flex-grow: 1;
    display: flex;
    align-items: center;
    background: #f0f2ee;
    border: 1px solid #e9e9e9;
    border-radius: 21px; /* 높이의 절반 */
    padding: 0 6px 0 16px;
}
.comment-form {
    flex-grow: 1;
    display: flex;
    align-items: center;
}
.comment-form textarea {
    flex-grow: 1;
    border: none;
    background: transparent;
    height: 42px;
    padding: 12px 0;
    resize: none;
    font-size: 0.95rem;
    outline: none;
}
.comment-form button {
    border: none;
    background: transparent;
    cursor: pointer;
    border-radius: 50%;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s;
    flex-shrink: 0;
}
.comment-form button:hover {
    background: #e0e5da;
}
.comment-form button svg {
    width: 20px;
    height: 20px;
    stroke: #355F19;
}   
#image-preview {
  display: none;
  max-width: 100%;
  max-height: 180px;   /* 👈 추가: 모달 내에서 너무 커지지 않도록 제한 */
  margin: 10px 0 0 0;
  border-radius: 8px;
  object-fit: contain; /* 👈 추가: 찌그러지지 않게 */
  box-shadow: 0 2px 10px rgba(80,100,70,0.07);
}


.image-upload-label {
    display: inline-block;
    padding: 10px 18px;
    background-color: #f0f0f0;
    color: #555;
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.2s;
    font-size: 0.95rem;
    font-weight: 500;
    margin-top: 10px;
}
.image-upload-label:hover {
    background-color: #e0e0e0;
}

#load-more-btn {
    border: 1.5px solid var(--primary-green);
    background: #fff;
    color: var(--primary-green);
    padding: 10px 28px;
    border-radius: 20px;
    font-size: 1rem;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.2s;
}
#load-more-btn:hover {
    background: var(--primary-green);
    color: #fff;
}
#load-more-btn.loading {
    cursor: wait;
    opacity: 0.7;
}

/* 기존 CSS 어딘가에 추가 */
.post-image {
    width: 100%;
    max-height: 400px;
    object-fit: cover;
}
.post-content {
    /* ... 기존 스타일 ... */
    white-space: pre-wrap; /* JS에서 \n을 <br>로 바꾸는 코드를 대체합니다. */
}
</style>
</head>
<body>

    <header id="main-header">
                       <a href="index.html" class="logo">
            <img src="logo.png" alt="오후의 식물 로고">
            <span>오후의 식물</span>
        </a>
        <nav>
            <a href="index.html">홈</a>
            <a href="story.html">초록 이야기</a>
            <a href="myPlant.html">나의 식물</a>
            <a href="findPlant.html">식물 찾기</a>
            <a href="payment.html">구독하기</a>
            <a href="#" class="cta-button">Login</a>
        </nav>
    </header>

    <div class="main-wrapper">
        <aside class="left-sidebar">
            <div class="quiz-widget">
                <h3>🌿 오늘의 퀴즈</h3>
                <p id="quiz-question" class="question">퀴즈를 불러오는 중입니다...</p>
                <div id="quiz-options" class="options"></div>
                <p id="quiz-feedback" class="feedback" style="display: none;"></p>
            </div>
        </aside>

        <div class="story-container">
            <button class="write-btn" id="open-story-modal" aria-label="초록 이야기 글쓰기">+</button>
            <div id="post-feed"></div>
            
            <div id="load-more-container" style="text-align: center; padding: 20px;">
                <button id="load-more-btn" style="display: none;">더 불러오기</button>
            </div>
        </div>
    </div>

    <div class="story-modal-wrapper" id="story-modal-wrapper">
        <div class="story-modal">
            <div class="story-modal-header">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
                <h2>초록 이야기 쓰기</h2>
            </div>
            <form id="story-form">
                <textarea id="story-content" placeholder="당신의 초록 이야기를 자유롭게 남겨주세요!" maxlength="2000" required></textarea>
                
                <label for="story-image-input" class="image-upload-label">
                    📷 이미지 첨부하기
                </label>
                <input type="file" id="story-image-input" accept="image/*" style="display: none;">
                
                <img id="image-preview" src="" style="display:none;max-width:100%;margin:10px 0 0 0;border-radius:8px;" />
                <div id="char-counter" class="char-counter">0 / 2000</div>

                <div class="modal-actions">
                    <button type="button" id="close-story-modal">취소</button>
                    <button type="submit" id="submit-story-btn">올리기</button>
                </div>
            </form>
        </div>
    </div>



     <div id="modal-wrapper" class="modal-wrapper">
        <div class="modal">
            <div class="modal-left"></div>
            <div class="modal-right">
                <button class="close-button">&times;</button>
                <!-- Login Form -->
                <div id="login-form" class="form-container">
                    <div class="form-header">
                        <a href="index.html" class="logo">오후의 식물</a>
                        <h2>Welcome Back</h2>
                    </div>
                    <form>
                        <div class="input-group">
                            <label for="login-email">Email</label>
                            <input type="email" id="login-email" required>
                        </div>
                        <div class="input-group">
                            <label for="login-password">Password</label>
                            <input type="password" id="login-password" required>
                        </div>
                        <button type="submit" class="cta-button">Login</button>
                    </form>
                    <p class="form-switcher">
                        Don't have an account? <a href="#" id="show-signup">Sign Up</a>
                    </p>
                </div>

                <!-- Signup Form -->
                <div id="signup-form" class="form-container" style="display: none;">
                    <div class="form-header">
                        <a href="index.html" class="logo">오후의 식물</a>
                        <h2>Create Account</h2>
                    </div>
                    <form>
                        <div class="input-group">
                            <label for="signup-name">Name</label>
                            <input type="text" id="signup-name" required>
                        </div>
                        <div class="input-group">
                            <label for="signup-email">Email</label>
                            <input type="email" id="signup-email" required>
                        </div>
                        <div class="input-group">
                            <label for="signup-password">Password</label>
                            <input type="password" id="signup-password" required>
                        </div>
                        <div class="agreement-group">
    <div class="checkbox-group">
        <input type="checkbox" id="signup-terms" name="terms" required>
        <label for="signup-terms">
            [필수] <a href="terms.html" target="_blank">이용약관</a>에 동의합니다.
        </label>
    </div>
    <div class="checkbox-group">
        <input type="checkbox" id="signup-privacy" name="privacy" required>
        <label for="signup-privacy">
            [필수] <a href="privacy.html" target="_blank">개인정보처리방침</a>에 동의합니다.
        </label>
    </div>
</div>

<button type="submit" class="cta-button">Create Account</button>
                    </form>
                    <p class="form-switcher">
                        Already have an account? <a href="#" id="show-login">Login</a>
                    </p>
                </div>
            </div>
        </div>
    </div>

<nav id="bottom-nav">
  <a href="index.html" class="nav-item">
    <span class="nav-icon">🏠</span>
    <span class="nav-label">홈</span>
  </a>
  <a href="story.html" class="nav-item">
    <span class="nav-icon">🌱</span>
    <span class="nav-label">초록 이야기</span>
  </a>
  <a href="myPlant.html" class="nav-item">
    <span class="nav-icon">🪴</span>
    <span class="nav-label">나의 식물</span>
  </a>
  <a href="findPlant.html" class="nav-item">
    <span class="nav-icon">💬</span>
    <span class="nav-label">식물 상담소</span>
  </a>
    <a href="payment.html" class="nav-item">
    <span class="nav-icon">⭐</span>
    <span class="nav-label">구독</span>
  </a>
</nav>
    <script type="module" src="navigation.js"></script>

        <!-- ====== JS: 이 페이지 전용 스크립트 ====== -->
    <script type="module">

        console.log("스토리지 객체:", storage);
    // === Firebase SDK import(이미 navigation.js에서 했으니 import 재사용) ===
// 1. navigation.js로부터 auth, db, storage 변수를 직접 import 합니다.
import { auth, db, storage } from './navigation.js'; 
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
// 스크립트 최상단 import 문을 수정하세요.
import { 
    collection, addDoc, query, orderBy, serverTimestamp, 
    doc, getDoc, updateDoc, increment, arrayUnion, arrayRemove,
    getDocs, limit, startAfter  // <--- 이 3개를 추가해야 합니다.
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

// ====== DOM Elements ======
const openBtn = document.getElementById('open-story-modal');
const modalWrapper = document.getElementById('story-modal-wrapper');
const closeBtn = document.getElementById('close-story-modal');
const storyForm = document.getElementById('story-form');
const storyContent = document.getElementById('story-content');
const charCounter = document.getElementById('char-counter');
const submitBtn = document.getElementById('submit-story-btn');
const feed = document.getElementById('post-feed');
const storyImageInput = document.getElementById('story-image-input');
const imagePreview = document.getElementById('image-preview');
const loadMoreBtn = document.getElementById('load-more-btn');

// ====== Pagination State ======
let lastVisible = null; // 마지막으로 불러온 문서를 저장
const POSTS_PER_PAGE = 10; // 한 번에 불러올 게시물 수

// ====== User State ======
let currentUser = null;
let currentUserName = "익명";

// onAuthStateChanged는 로드 시 항상 한 번 실행됩니다. (로그인 또는 로그아웃 상태)
// 이 함수가 사용자 상태를 확인한 후, loadStories()를 호출하는 것이 가장 안정적입니다.
onAuthStateChanged(auth, async (user) => {
    currentUser = user;
    if (user) {
        const userDocRef = doc(db, "users", user.uid);
        const userDoc = await getDoc(userDocRef);
        currentUserName = userDoc.exists() ? userDoc.data().name : "익명";
    } else {
        currentUserName = "익명";
    }
    // 사용자 정보가 확정된 후에 게시물 렌더링 시작
    loadStories(); 
});


// ====== Modal & Form Logic ======
openBtn.addEventListener('click', () => {
    if (!currentUser) {
        document.querySelector('.cta-button').click();
        return;
    }
    storyForm.reset(); 
    charCounter.textContent = "0 / 2000";
    modalWrapper.classList.add('open');
    setTimeout(() => storyContent.focus(), 250);
});
closeBtn.addEventListener('click', () => modalWrapper.classList.remove('open'));
modalWrapper.addEventListener('click', (e) => {
    if (e.target === modalWrapper) modalWrapper.classList.remove('open');
});
storyContent.addEventListener('input', () => {
    charCounter.textContent = `${storyContent.value.length} / 2000`;
});

// 글 작성 시 likes와 comments 필드를 빈 배열로 초기화


// ====== Time Formatting Function ======
function timeForToday(value) {
    if (!value) return "";
    // Firestore Timestamp 객체와 JS Date 객체 모두 처리
    const timeValue = value.toDate ? value.toDate() : value;
    const today = new Date();
    const betweenTime = Math.floor((today.getTime() - timeValue.getTime()) / 1000 / 60);

    if (betweenTime < 1) return '방금 전';
    if (betweenTime < 60) return `${betweenTime}분 전`;
    
    const betweenTimeHour = Math.floor(betweenTime / 60);
    if (betweenTimeHour < 24) return `${betweenTimeHour}시간 전`;

    const betweenTimeDay = Math.floor(betweenTime / 60 / 24);
    if (betweenTimeDay < 365) return `${betweenTimeDay}일 전`;

    return `${Math.floor(betweenTimeDay / 365)}년 전`;
}


// ====== Display Stories & Comments ======
// ====== Display Stories & Comments ======
async function loadStories() {
    feed.innerHTML = ""; // 피드를 비웁니다.
    lastVisible = null;  // 페이지네이션 상태 초기화
    loadMoreBtn.style.display = 'none'; // 버튼 숨기기

    const firstBatch = query(
        collection(db, "stories"), 
        orderBy("createdAt", "desc"), 
        limit(POSTS_PER_PAGE)
    );

    const documentSnapshots = await getDocs(firstBatch);

    if (documentSnapshots.empty) {
        feed.innerHTML = `<div style="color:#888;padding:30px;text-align:center;">아직 작성된 이야기가 없어요. 첫 번째 이야기를 남겨주세요!</div>`;
        return;
    }

    // 마지막 문서를 저장
    lastVisible = documentSnapshots.docs[documentSnapshots.docs.length - 1];

    // 가져온 문서들을 화면에 렌더링
    documentSnapshots.forEach(doc => {
        renderPost(doc); // 게시물 하나를 렌더링하는 함수 (아래에서 만듦)
    });
    
    // 불러온 게시물 수가 페이지당 게시물 수와 같으면 '더 불러오기' 버튼 표시
    if (documentSnapshots.docs.length === POSTS_PER_PAGE) {
        loadMoreBtn.style.display = 'inline-block';
    }
}

function renderPost(doc) {
    const story = doc.data();
    const storyId = doc.id;
    
    const isLiked = currentUser ? story.likes?.includes(currentUser.uid) : false;
    const authorName = story.author || "익명";
    const dateStr = story.createdAt ? timeForToday(story.createdAt) : "";
    const userInitial = (currentUserName?.charAt(0) || 'P').toUpperCase();
    const isLoggedIn = !!currentUser;

    let imageHtml = '';
    if (story.imageUrl) {
        // 이미지는 카드의 맨 위에 위치해야 radius가 예쁘게 적용됩니다.
        imageHtml = `<img src="${story.imageUrl}" alt="스토리 이미지" class="post-image"/>`;
    }

    let commentsHtml = '';
    if (story.comments && story.comments.length > 0) {
        const reversedComments = [...story.comments].reverse();
        reversedComments.forEach(comment => {
            commentsHtml += `
                <div class="comment">
                    <strong class="comment-author">${comment.author}</strong>
                    <span class="comment-text">${comment.text}</span>
                    <span class="comment-date">${timeForToday(comment.createdAt)}</span>
                </div>
            `;
        });
    }

    const card = document.createElement('div');
    card.className = 'post-card';
    card.dataset.postId = storyId;
    card.innerHTML = `
        ${imageHtml}
        <div class="post-card-content">
            <div class="post-header">
                <div class="post-author-avatar">${authorName.charAt(0).toUpperCase()}</div>
                <div class="post-author-info">
                    <span class="post-author">${authorName}</span>
                    <span class="post-date">${dateStr}</span>
                </div>
            </div>
            <p class="post-content">${story.content}</p>
        </div>
        <div class="post-actions">
            <button class="action-btn like-btn ${isLiked ? 'liked' : ''}">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                <span class="like-count">${story.likesCount || 0}</span>
            </button>
            <button class="action-btn comment-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
                <span class="comment-count-text">댓글 ${story.comments?.length || 0}</span>
            </button>
        </div>
        <div class="comments-section">
            <div class="comments-list">${commentsHtml}</div>
            <div class="comment-input-area">
                <div class="comment-user-avatar ${isLoggedIn ? '' : 'disabled'}">${isLoggedIn ? userInitial : '?'}</div>
                <div class="comment-input-wrapper">
                    <form class="comment-form">
                        <textarea name="comment" placeholder="${isLoggedIn ? '댓글을 남겨주세요...' : '로그인 후 댓글을 달 수 있습니다.'}" ${isLoggedIn ? '' : 'disabled'} required></textarea>
                        <button type="submit" ${isLoggedIn ? '' : 'disabled'}>
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    `;
    feed.appendChild(card);
}

// ====== Event Delegation for Likes and Comments ======
feed.addEventListener('click', async (e) => {
    // --- Like Button Click ---
    const likeBtn = e.target.closest('.like-btn');
    if (likeBtn) {
        if (!currentUser) {
            document.querySelector('.cta-button').click();
            return;
        }
        const card = likeBtn.closest('.post-card');
        const storyId = card.dataset.postId;
        const storyRef = doc(db, "stories", storyId);

        // arrayUnion/arrayRemove을 사용하여 동시성 문제를 해결합니다.
        if (likeBtn.classList.contains('liked')) {
            // Unlike
            await updateDoc(storyRef, {
                likes: arrayRemove(currentUser.uid),
                likesCount: increment(-1)
            });
        } else {
            // Like
            await updateDoc(storyRef, {
                likes: arrayUnion(currentUser.uid),
                likesCount: increment(1)
            });
        }
    }
    
    // --- Comment Button Click (to focus textarea) ---
    const commentBtn = e.target.closest('.comment-btn');
    if (commentBtn) {
        const card = commentBtn.closest('.post-card');
        card.querySelector('.comment-form textarea').focus();
    }
});

feed.addEventListener('submit', async (e) => {
    // --- Comment Form Submission ---
    if (e.target.classList.contains('comment-form')) {
        e.preventDefault();
        if (!currentUser) {
            alert("댓글을 작성하려면 로그인이 필요합니다.");
            return;
        }

        const form = e.target;
        const textarea = form.querySelector('textarea');
        const text = textarea.value.trim();
        if (!text) return;

        const card = form.closest('.post-card');
        const storyId = card.dataset.postId;
        const storyRef = doc(db, "stories", storyId);
        
        const newComment = {
            text: text,
            author: currentUserName,
            uid: currentUser.uid,
            createdAt: new Date() 
        };

        // DB 업데이트
        await updateDoc(storyRef, {
            comments: arrayUnion(newComment)
        });
        
        // ▼▼▼ UI 수동 업데이트 로직 추가 ▼▼▼
        const commentsList = card.querySelector('.comments-list');
        const commentCountText = card.querySelector('.comment-count-text');

        // 1. 새 댓글 엘리먼트 생성
        const newCommentEl = document.createElement('div');
        newCommentEl.className = 'comment';
        newCommentEl.innerHTML = `
            <strong class="comment-author">${newComment.author}</strong>
            <span class="comment-text">${newComment.text}</span>
            <span class="comment-date">방금 전</span>`;
        
        // 2. 목록 맨 위에 새 댓글 추가 (최신순)
        commentsList.prepend(newCommentEl);

        // 3. 댓글 개수 업데이트
        const newCount = card.querySelectorAll('.comment').length;
        commentCountText.textContent = `댓글 ${newCount}`;
        
        // 4. 입력창 초기화
        form.reset();
    }
});

// loadMoreStories 함수 생성
async function loadMoreStories() {
    if (!lastVisible) { // 더 이상 불러올 문서가 없으면 중단
        return;
    }

    loadMoreBtn.classList.add('loading');
    loadMoreBtn.disabled = true;

    const nextBatch = query(
        collection(db, "stories"),
        orderBy("createdAt", "desc"),
        startAfter(lastVisible), // 마지막으로 본 문서 다음부터
        limit(POSTS_PER_PAGE)
    );

    const documentSnapshots = await getDocs(nextBatch);
    
    if (documentSnapshots.empty) {
        loadMoreBtn.style.display = 'none'; // 더 이상 문서가 없으면 버튼 숨기기
        return;
    }

    lastVisible = documentSnapshots.docs[documentSnapshots.docs.length - 1];
    
    documentSnapshots.forEach(doc => {
        renderPost(doc);
    });

    if (documentSnapshots.docs.length < POSTS_PER_PAGE) {
        loadMoreBtn.style.display = 'none'; // 마지막 페이지이면 버튼 숨기기
    }
    
    loadMoreBtn.classList.remove('loading');
    loadMoreBtn.disabled = false;
}

// '더 불러오기' 버튼에 클릭 리스너 추가
loadMoreBtn.addEventListener('click', loadMoreStories);

// ====== 오늘의 퀴즈 로직 ======

const quizData = [
    {
        question: "식물의 잎이 노랗게 변하는 가장 흔한 원인은 무엇일까요?",
        options: ["물 부족", "과습", "햇빛 과다", "병충해"],
        correctAnswer: "과습",
        explanation: "뿌리가 과도한 물에 잠겨 숨을 쉬지 못하면, 잎으로 가는 영양 공급이 중단되어 잎이 노랗게 변하게 됩니다."
    },
    {
        question: "NASA가 선정한 공기정화식물 1위로 알려진 식물은 무엇일까요?",
        options: ["스투키", "아레카야자", "관음죽", "스파티필룸"],
        correctAnswer: "아레카야자",
        explanation: "아레카야자는 포름알데히드와 같은 유해물질 제거 능력이 뛰어나고, 가습 효과도 있어 실내 식물로 인기가 많습니다."
    },
    {
        question: "식물의 '광합성'에 꼭 필요한 3가지 요소가 아닌 것은 무엇일까요?",
        options: ["햇빛", "물", "산소", "이산화탄소"],
        correctAnswer: "산소",
        explanation: "광합성은 햇빛, 물, 이산화탄소를 이용해 포도당(양분)과 '산소'를 만들어내는 과정입니다. 산소는 결과물이지, 필요 요소는 아니에요."
    },
    {
        question: "식물의 줄기나 잎을 잘라 새로운 개체를 만드는 번식 방법을 무엇이라고 할까요?",
        options: ["파종", "분갈이", "꺾꽂이(삽목)", "물꽂이"],
        correctAnswer: "꺾꽂이(삽목)",
        explanation: "꺾꽂이(삽목)는 식물의 영양생식 방법 중 하나로, 부모 식물과 동일한 유전자를 가진 새로운 식물을 쉽게 얻을 수 있습니다."
    },
    {
        question: "다육식물에 물을 너무 자주 주면 안 되는 주된 이유는 무엇일까요?",
        options: ["잎이 너무 커져서", "뿌리가 썩기 쉬워서", "색이 옅어져서", "가시가 무뎌져서"],
        correctAnswer: "뿌리가 썩기 쉬워서",
        explanation: "다육식물은 건조한 환경에 적응하여 잎에 물을 저장합니다. 물을 너무 자주 주면 뿌리가 계속 젖어있어 썩기 쉽습니다."
    },
    {
        question: "몬스테라 잎에 구멍이 뚫려있는 자연적인 이유는 무엇일까요?",
        options: ["벌레가 파먹어서", "스스로 무게를 줄이기 위해", "아래쪽 잎까지 빛을 보내기 위해", "물을 더 잘 흡수하기 위해"],
        correctAnswer: "아래쪽 잎까지 빛을 보내기 위해",
        explanation: "몬스테라는 큰 잎을 가진 덩굴성 식물입니다. 잎에 구멍이 있으면 위쪽 잎이 아래쪽 잎의 햇빛을 가리는 것을 최소화할 수 있습니다."
    },
    {
        question: "반려동물에게 독성이 있어 키울 때 주의해야 하는 식물이 아닌 것은?",
        options: ["백합", "아이비", "알로에 베라", "캣닢"],
        correctAnswer: "캣닢",
        explanation: "백합, 아이비, 알로에 베라는 반려동물에게 중독 증상을 일으킬 수 있어 주의가 필요합니다. 캣닢은 고양이에게 안전하고 오히려 즐거움을 줍니다."
    }
];

function displayDailyQuiz() {
    const today = new Date();
    // 기준일로부터 며칠이 지났는지 계산하여 매일 다른 퀴즈가 나오도록 수정
    const startDate = new Date('2025-01-01');
    const diffTime = Math.abs(today - startDate);
    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24)); 
    const quizIndex = diffDays % quizData.length;
    const dailyQuiz = quizData[quizIndex];
    
    const questionEl = document.getElementById('quiz-question');
    const optionsEl = document.getElementById('quiz-options');
    const feedbackEl = document.getElementById('quiz-feedback');

    questionEl.textContent = dailyQuiz.question;
    optionsEl.innerHTML = ""; // 이전 옵션 초기화
    feedbackEl.style.display = 'none';

    // 로컬 스토리지에서 오늘 퀴즈를 풀었는지 확인
    const lastQuizDate = localStorage.getItem('lastQuizDate');
    const hasAnsweredToday = lastQuizDate === today.toDateString();

    dailyQuiz.options.forEach(optionText => {
        const optionBtn = document.createElement('button');
        optionBtn.className = 'option';
        optionBtn.textContent = optionText;
        optionsEl.appendChild(optionBtn);

        if (hasAnsweredToday) {
            showResult(optionBtn, dailyQuiz, feedbackEl);
        } else {
             optionBtn.addEventListener('click', () => handleOptionClick(optionBtn, dailyQuiz));
        }
    });
}

function handleOptionClick(selectedBtn, quiz) {
     const today = new Date();
     localStorage.setItem('lastQuizDate', today.toDateString()); // 오늘 날짜로 기록

    const optionsContainer = document.getElementById('quiz-options');
    const allOptions = optionsContainer.querySelectorAll('.option');

    allOptions.forEach(optionBtn => {
        showResult(optionBtn, quiz, document.getElementById('quiz-feedback'));
    });
}

function showResult(optionBtn, quiz, feedbackEl) {
    const optionText = optionBtn.textContent;
    optionBtn.classList.add('disabled'); // 모든 버튼 비활성화

    if (optionText === quiz.correctAnswer) {
        optionBtn.classList.add('correct');
    } else {
        optionBtn.classList.add('incorrect');
    }
    
    feedbackEl.textContent = quiz.explanation;
    feedbackEl.style.display = 'block';
}


// 퀴즈 기능 실행
displayDailyQuiz();


storyImageInput.addEventListener('change', function () {
    const file = this.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            imagePreview.src = e.target.result;
            imagePreview.style.display = 'block';
        };
        reader.readAsDataURL(file);
    } else {
        imagePreview.src = '';
        imagePreview.style.display = 'none';
    }
});

storyForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!currentUser) {
        alert("로그인 후 작성할 수 있습니다.");
        return;
    }
    const content = storyContent.value.trim();
    if (!content) return;

    submitBtn.disabled = true;
    submitBtn.classList.add('loading');
    submitBtn.textContent = '올리는 중...';

    // 1. 이미지 파일 체크
    const file = storyImageInput.files[0];
    let imageUrl = "";

    try {
        // 2. 이미지가 첨부됐으면 Storage에 업로드
        if (file) {
            const storageRef = ref(storage, `stories/${currentUser.uid}_${Date.now()}_${file.name}`);
            const snapshot = await uploadBytes(storageRef, file);
            imageUrl = await getDownloadURL(snapshot.ref);
        }
        // 3. Firestore에 저장 (imageUrl 포함)
        await addDoc(collection(db, "stories"), {
            content,
            author: currentUserName,
            uid: currentUser.uid,
            createdAt: serverTimestamp(),
            likesCount: 0,
            likes: [],
            comments: [],
            imageUrl: imageUrl // 이미지 없으면 빈 문자열
        });

        modalWrapper.classList.remove('open');
        // 초기화
        storyImageInput.value = '';
        imagePreview.src = '';
        imagePreview.style.display = 'none';

        // ▼ 이 한 줄을 추가하여 피드를 새로고침합니다.
        loadStories(); 
    } catch (err) {
        alert("글 저장 중 오류가 발생했습니다: " + err.message);
    } finally {
        submitBtn.disabled = false;
        submitBtn.classList.remove('loading');
        submitBtn.textContent = '올리기';
    }
});

// ====== Modal & Form Logic ======

// 모달을 닫는 공통 함수를 만듭니다.
function closeModal() {
    modalWrapper.classList.remove('open');
    storyForm.reset();
    imagePreview.src = '';
    imagePreview.style.display = 'none';
    charCounter.textContent = "0 / 2000";
}

openBtn.addEventListener('click', () => {
    if (!currentUser) {
        document.querySelector('.cta-button').click();
        return;
    }
    // storyForm.reset() 등은 closeModal 함수가 처리하므로 여기선 제거
    modalWrapper.classList.add('open');
    setTimeout(() => storyContent.focus(), 250);
});

// 기존 리스너들을 closeModal 함수 호출로 변경
closeBtn.addEventListener('click', closeModal);
modalWrapper.addEventListener('click', (e) => {
    if (e.target === modalWrapper) {
        closeModal();
    }
});

storyContent.addEventListener('input', () => {
    charCounter.textContent = `${storyContent.value.length} / 2000`;
});


// ====== Event Delegation for Likes and Comments ======
feed.addEventListener('click', async (e) => {
    // --- Like Button Click ---
    const likeBtn = e.target.closest('.like-btn');
    if (likeBtn) {
        if (!currentUser) {
            document.querySelector('.cta-button').click();
            return;
        }
        const card = likeBtn.closest('.post-card');
        const storyId = card.dataset.postId;
        const storyRef = doc(db, "stories", storyId);
        const likeCountSpan = likeBtn.querySelector('.like-count');
        const currentCount = parseInt(likeCountSpan.textContent);

        // UI를 먼저 업데이트하고 DB에 요청을 보낼 수도 있습니다 (낙관적 업데이트).
        likeBtn.classList.toggle('liked'); 

        if (likeBtn.classList.contains('liked')) {
            // UI 업데이트
            likeCountSpan.textContent = currentCount + 1;
            // DB 업데이트
            await updateDoc(storyRef, {
                likes: arrayUnion(currentUser.uid),
                likesCount: increment(1)
            });
        } else {
            // UI 업데이트
            likeCountSpan.textContent = currentCount - 1;
            // DB 업데이트
            await updateDoc(storyRef, {
                likes: arrayRemove(currentUser.uid),
                likesCount: increment(-1)
            });
        }
    }
    
    // --- Comment Button Click (to focus textarea) ---
    const commentBtn = e.target.closest('.comment-btn');
    if (commentBtn) {
        const card = commentBtn.closest('.post-card');
        card.querySelector('.comment-form textarea').focus();
    }
});
    </script>
</body>
</html>